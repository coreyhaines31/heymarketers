<!-- Job Listings Directory ---->
<div class="min-h-screen" style="background-color: var(--color-background);">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold" style="color: var(--color-foreground);">Find Your Next Marketing Role</h1>
          <p class="mt-1" style="color: var(--color-muted-foreground);">
            <% if @search_params[:query].present? %>
              Found <%= @total_count %> job opportunities for "<%= @search_params[:query] %>"
            <% else %>
              Browse <%= @total_count %> job opportunities from top companies
            <% end %>
          </p>
        </div>
        <div class="flex items-center space-x-3">
          <button id="toggle-advanced-filters" class="btn btn-outline">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z" />
            </svg>
            <span class="filter-text">Advanced Filters</span>
          </button>
          <% if user_signed_in? && current_user.company? %>
            <%= link_to new_company_profile_job_listing_path(current_user.accounts.joins(:company_profile).first.company_profile), class: "btn btn-primary" do %>
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Post a Job
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Search & Filters -->
    <div class="card mb-8">
      <div class="card-body">
        <%= form_with url: jobs_path, method: :get, local: true, class: "space-y-6", id: "search-form" do |f| %>

          <!-- Main Search Bar -->
          <div class="flex gap-4">
            <div class="flex-1">
              <%= f.text_field :query,
                  placeholder: "Search by job title, company, or description...",
                  value: @search_params[:query],
                  class: "input w-full text-lg",
                  autocomplete: "off" %>
            </div>
            <div class="flex items-center space-x-2">
              <%= f.select :sort,
                  options_for_select(@sort_options.map { |s| [s.humanize, s] }, @search_params[:sort]),
                  { prompt: "Sort by..." },
                  { class: "input" } %>
              <%= f.submit "Search", class: "btn btn-primary px-6" %>
            </div>
          </div>

          <!-- Quick Filters -->
          <div class="flex flex-wrap gap-3">
            <% if @search_params.any? { |k, v| v.present? && k != 'query' && k != 'sort' } %>
              <%= link_to "Clear Filters", jobs_path, class: "btn btn-outline btn-sm" %>
            <% end %>

            <!-- Active Filter Tags -->
            <% if @search_params[:location_id].present? %>
              <% location = @locations.find { |l| l.id.to_s == @search_params[:location_id].to_s } %>
              <% if location %>
                <span class="inline-flex items-center px-3 py-1 text-sm rounded-full" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                  üìç <%= location.name %>
                  <%= link_to jobs_path(@search_params.except(:location_id)), class: "ml-2 hover:text-red-600" do %>
                    √ó
                  <% end %>
                </span>
              <% end %>
            <% end %>

            <% if @search_params[:employment_type].present? %>
              <span class="inline-flex items-center px-3 py-1 text-sm rounded-full" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                üíº <%= @search_params[:employment_type].humanize %>
                <%= link_to jobs_path(@search_params.except(:employment_type)), class: "ml-2 hover:text-red-600" do %>
                  √ó
                <% end %>
              </span>
            <% end %>

            <% if @search_params[:remote_ok] == 'true' %>
              <span class="inline-flex items-center px-3 py-1 text-sm rounded-full" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                üè† Remote OK
                <%= link_to jobs_path(@search_params.except(:remote_ok)), class: "ml-2 hover:text-red-600" do %>
                  √ó
                <% end %>
              </span>
            <% end %>

            <% if @search_params[:min_salary].present? || @search_params[:max_salary].present? %>
              <span class="inline-flex items-center px-3 py-1 text-sm rounded-full" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                üí∞ $<%= @search_params[:min_salary] || '0' %> - $<%= @search_params[:max_salary] || '‚àû' %>
                <%= link_to jobs_path(@search_params.except(:min_salary, :max_salary)), class: "ml-2 hover:text-red-600" do %>
                  √ó
                <% end %>
              </span>
            <% end %>

            <% if @search_params[:posted_within].present? %>
              <% posted_text = @posted_within_options.find { |opt| opt[1] == @search_params[:posted_within] }&.first %>
              <% if posted_text %>
                <span class="inline-flex items-center px-3 py-1 text-sm rounded-full" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                  üìÖ <%= posted_text %>
                  <%= link_to jobs_path(@search_params.except(:posted_within)), class: "ml-2 hover:text-red-600" do %>
                    √ó
                  <% end %>
                </span>
              <% end %>
            <% end %>
          </div>

          <!-- Advanced Filters Panel -->
          <div id="advanced-filters" class="border-t pt-6" style="border-color: var(--color-border); display: none;">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

              <!-- Location Filter -->
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--color-foreground);">Location</label>
                <%= f.select :location_id,
                    options_from_collection_for_select(@locations, :id, :name, @search_params[:location_id]),
                    { prompt: "All Locations" },
                    { class: "input w-full" } %>
              </div>

              <!-- Employment Type Filter -->
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--color-foreground);">Employment Type</label>
                <%= f.select :employment_type,
                    options_for_select(@employment_types.map { |type| [type.humanize, type] }, @search_params[:employment_type]),
                    { prompt: "Any Type" },
                    { class: "input w-full" } %>
              </div>

              <!-- Company Size -->
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--color-foreground);">Company Size</label>
                <%= f.select :company_size,
                    options_for_select(@company_sizes.map { |size| [size.humanize, size] }, @search_params[:company_size]),
                    { prompt: "Any Size" },
                    { class: "input w-full" } %>
              </div>

              <!-- Posted Within -->
              <div>
                <label class="block text-sm font-medium mb-2" style="color: var(--color-foreground);">Posted</label>
                <%= f.select :posted_within,
                    options_for_select(@posted_within_options, @search_params[:posted_within]),
                    {},
                    { class: "input w-full" } %>
              </div>

              <!-- Salary Range -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2" style="color: var(--color-foreground);">Salary Range</label>
                <div class="flex space-x-2">
                  <%= f.number_field :min_salary,
                      placeholder: "Min ($)",
                      value: @search_params[:min_salary],
                      class: "input w-full" %>
                  <%= f.number_field :max_salary,
                      placeholder: "Max ($)",
                      value: @search_params[:max_salary],
                      class: "input w-full" %>
                </div>
              </div>

              <!-- Remote Work -->
              <div class="flex items-center">
                <label class="flex items-center cursor-pointer">
                  <%= f.check_box :remote_ok,
                      { checked: @search_params[:remote_ok] == 'true' },
                      'true', '' %>
                  <span class="ml-2 text-sm" style="color: var(--color-foreground);">Remote work available</span>
                </label>
              </div>

              <!-- Filter Actions -->
              <div class="flex items-end space-x-2">
                <%= f.submit "Apply Filters", class: "btn btn-primary" %>
                <%= link_to "Reset", jobs_path, class: "btn btn-outline" %>
              </div>
            </div>
          </div>

        <% end %>
      </div>
    </div>

    <!-- Results -->
    <% if @job_listings.any? %>
      <div class="space-y-6">
        <% @job_listings.each do |job| %>
          <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-semibold" style="background-color: var(--color-primary);">
                      <%= job.company_profile.name.first(2).upcase %>
                    </div>
                    <div class="flex-1">
                      <div class="flex items-start justify-between">
                        <div>
                          <h3 class="text-lg font-semibold" style="color: var(--color-foreground);">
                            <%= link_to job.title, job_path(job), class: "hover:underline" %>
                          </h3>
                          <p class="text-sm" style="color: var(--color-muted-foreground);">
                            <%= job.company_profile.name %>
                            <% if job.location %>
                              ‚Ä¢ <%= job.location.name %>
                            <% end %>
                            <% if job.remote_ok %>
                              ‚Ä¢ üè† Remote OK
                            <% end %>
                          </p>
                          <p class="text-xs mt-1" style="color: var(--color-muted-foreground);">
                            Posted <%= time_ago_in_words(job.posted_at) %> ago
                          </p>
                        </div>
                        <div class="text-right">
                          <p class="font-semibold" style="color: var(--color-foreground);"><%= job.display_salary %></p>
                          <span class="badge badge-outline"><%= job.employment_type_display %></span>
                        </div>
                      </div>
                      <p class="text-sm mt-3 leading-relaxed" style="color: var(--color-muted-foreground);">
                        <%= truncate(job.description, length: 200) %>
                      </p>
                      <div class="flex items-center justify-between mt-4">
                        <div class="flex items-center space-x-3">
                          <span class="text-xs px-2 py-1 rounded" style="background-color: var(--color-accent); color: var(--color-accent-foreground);">
                            <%= job.company_profile.company_size.humanize if job.company_profile.company_size %>
                          </span>
                          <% if job.expires_at %>
                            <span class="text-xs" style="color: var(--color-muted-foreground);">
                              Expires <%= job.expires_at.strftime("%b %d") %>
                            </span>
                          <% end %>
                        </div>
                        <div class="flex items-center space-x-2">
                          <%= link_to "Learn More", job_path(job), class: "btn btn-outline btn-sm" %>
                          <% if user_signed_in? %>
                            <%= link_to "Apply Now", job_path(job), class: "btn btn-primary btn-sm" %>
                          <% else %>
                            <%= link_to "Apply Now", job_path(job), class: "btn btn-primary btn-sm" %>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Pagination -->
      <div class="mt-8 flex justify-center">
        <%= paginate @job_listings, params: @search_params %>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="text-center py-12">
        <div class="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4" style="background-color: var(--color-accent);">
          <svg class="w-8 h-8" style="color: var(--color-primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2V6z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium mb-2" style="color: var(--color-foreground);">No jobs found</h3>
        <p class="text-sm mb-6" style="color: var(--color-muted-foreground);">Try adjusting your filters or browse all opportunities</p>
        <%= link_to "Clear Filters", jobs_path, class: "btn btn-outline" %>
      </div>
    <% end %>

    <!-- Call to Action for Companies -->
    <% if user_signed_in? && !current_user.company? %>
      <div class="mt-12 text-center">
        <div class="card">
          <div class="card-body">
            <h3 class="text-lg font-semibold mb-2" style="color: var(--color-foreground);">Are you hiring marketing talent?</h3>
            <p class="text-sm mb-4" style="color: var(--color-muted-foreground);">Post your job and connect with qualified marketing professionals</p>
            <%= link_to "Post a Job", new_user_registration_path(user_type: 'company'), class: "btn btn-primary" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- JavaScript for Advanced Search Functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Advanced Filters Toggle
  const toggleButton = document.getElementById('toggle-advanced-filters');
  const advancedFilters = document.getElementById('advanced-filters');
  const filterText = toggleButton.querySelector('.filter-text');

  if (toggleButton && advancedFilters) {
    toggleButton.addEventListener('click', function() {
      const isVisible = advancedFilters.style.display !== 'none';

      if (isVisible) {
        advancedFilters.style.display = 'none';
        filterText.textContent = 'Advanced Filters';
      } else {
        advancedFilters.style.display = 'block';
        filterText.textContent = 'Hide Filters';
      }
    });

    // Show advanced filters if any advanced filters are active
    const hasAdvancedFilters = <%= (@search_params[:employment_type].present? ||
                                   @search_params[:company_size].present? ||
                                   @search_params[:posted_within].present? ||
                                   @search_params[:min_salary].present? ||
                                   @search_params[:max_salary].present? ||
                                   @search_params[:remote_ok].present?).to_json %>;

    if (hasAdvancedFilters) {
      advancedFilters.style.display = 'block';
      filterText.textContent = 'Hide Filters';
    }
  }

  // Auto-submit form on sort change
  const sortSelect = document.querySelector('select[name="sort"]');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      this.form.submit();
    });
  }

  // Real-time search with debouncing
  const searchInput = document.querySelector('input[name="query"]');
  if (searchInput) {
    let searchTimeout;

    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);

      searchTimeout = setTimeout(() => {
        // Only auto-submit if user has typed at least 3 characters or cleared the field
        if (this.value.length >= 3 || this.value.length === 0) {
          this.form.submit();
        }
      }, 500); // 500ms delay
    });
  }
});
</script>